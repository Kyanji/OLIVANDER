# Evading Anti-Malware Measures in Windows PE with Counterfactual Explanations

The repository contains code refered to the work:

_Evading Anti-Malware Measures in Windows PE with Counterfactual Explanations_
 
Please cite our work if you find it useful for your research and work.

## Data

The dataset used for OLIVANDER can be found at the following [LINK](https://practicalsecurityanalytics.com/pe-malware-machine-learning-dataset/)

Dumps of lief features dataset and counterfactuals generated by the method are also available [HERE](https://drive.google.com/drive/folders/1WJFbRPP9dEFccRM5J7kyraO1Fuy9tB3y?usp=sharing)


## Code requirements
The code relies on the following python3.6+ libs.
Packages needed are:
* liblief==0.9
* numpy==1.19.2
* dice-ml==0.11
* keras==2.6.0
* tensorflow==2.6.2
* scikit-learn==0.24.2
* pandas==1.1.5
* ember==0.1.0
* scipy==1.5.2


## Structure

The repository contains the following scripts and folders:
* main.py:  script to execute OLIVANDER
* /results: results folder
* /pickle: folder used to save the results of the method. Specifically, a folder with a name containing the specific parameters used will be created. **The actual evasive PE files will be referred to as "final-"**
* /libs: script used by the method. 
* /models: it contain the DNN used as oracle
* config.ini: file containing the paths used by the method
# Parameters
A config.ini template:
```ini

[SETTINGS]
# Counterfactuals Dump
counterfactual_path=pickle/counterfactuals.pickle
# Path to the folder containing the dataset. In particular, the folder must contain the samples.csv and the samples folder with all the executable pe files 
pe_folder=/media/HDD/data/dataset/pe-machine-learning-dataset/
# Dump of the extracted lief dataset 
lief_dataset=pickle/dataset_lief.pickle
```

## How to use

The python script supports the following parameters:
* --mode: 
  * generate_dataset: extracts the lief features from the original PE files, generate the counterfactuals and finally, it creates the adversarial samples
  * load_dataset: uses the already extracted lief features from the "lief_dataset" folder and execute the method
  * load_counterfactual: loads the counterfactual examples from the "counterfactual_path" folder and generates the adversarial samples
* --eta: [10,100,1000]
* --c: [10,100,1000]
* --offsetmin: min offset used to extract the conterfactual exampled from the lief feature dataset  
* --offsetmax: max offset used to extract the conterfactual exampled from the lief feature dataset  
```console
python3 main.py --mode generate_dataset --step 1000 --c 100 --offsetmin 100 --offsetmax 200 #default setup
python3 main.py --mode load_counterfactual --step 1000 --c 100 
```

